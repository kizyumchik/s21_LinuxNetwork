## Part 1. Инструмент **ipcalc**

- Установим утилиту `ipcalc` с помощью команды `sudo apt install ipcalc`  

#### 1.1 Сети и маски

1. Определяем адрес сети `192.167.38.54/13` с помощью `ipcalc`
   
   ![ip addr](images/1_1_ip_addr.png)`

2. Переводим маску `255.255.255.0` в префискную и двоичную запись, `/15` в обычную и двоичную, `11111111.11111111.11111111.11110000` в обычную и префиксную
   
   ![mask](images/1_1_mask.png)
   
   *маска подсети в префиксной и двоичной записи*
   
   ![mask1](images/1_1_mask1.png)
   
   *маска `/15` в обычной и двоичной записи*
   
   ![mask2](images/1_1_mask2.png)
   
   *маска `11111111.11111111.11111111.11110000`  в обычной записи*
   
   ![mask3](images/1_1_mask3.png)
   
   *маска `11111111.11111111.11111111.11110000` в префиксной записи*

3. Определяем минимальный и максимальный хост в сети `12.167.38.4` при масках: `/8`, `1111111.11111111.00000000.00000000`, `255.255.254.0` и `/4`
   
   Командой `ipcalc 12.167.38.4/8` определяем минимальный и максимальный хост сети при маске `/8`:
   
   ![host](images/1_1_3_host.png)
   
   Командой `ipcalc 12.167.38.4/16` определяем минимальный и максимальный хост сети при маске `1111111.11111111.00000000.00000000`:
   
   ![host1](images/1_1_3_host1.png)
   
   Командой `ipcalc 12.167.38.4/255.255.254.0` определяем минимальный и максимальный хост сети при маске `255.255.254.0`:
   
   ![host2](images/1_1_3_host2.png)
   
   Командой `ipcalc 12.167.38.4/4` определяем минимальный и максимальный хост сети при маске `/4`:
   
   ![host3](images/1_1_3_host3.png)

#### 1.2 localhost

- Приложение, работающее на `localhost`, обычно ссылается на IP-адрес `127.0.0.1`.  Значит, приложение доступно только для запросов, исходящих с той же машины, на которой оно запущено

- **`194.34.23.100`**- это внешний IP-адрес, обращение к приложению на `localhost` с этого адреса **невозможно**

- **`127.0.0.2`** - это адрес в диапазоне `127.0.0.0/8`, который относится к `localhost`, обращение к приложению на `localhost` **возможно**

- **`127.1.0.1`** - это адрес в диапазоне `127.0.0.0/8`, который относится к `localhost`, обращение к приложению на `localhost` **возможно**

- **`128.0.0.1`** - это адрес не находится в диапазоне `127.0.0.0/8` и является публичным IP-адресом, обращение к приложению на `localhost` **невозможно**

#### 1.3 Диапозоны и сегменты сетей

1. Для определения, какие IP являются публичными, а какие - частными, нужно учитывать диапазоны частных IP-адресов, которые установлены в стандарте RFC 1918:
   
   - **`10.0.0.0 - 10.255.255.255`** `(10.0.0.0/8)`
   
   - **`172.16.0.0. - 172.31.255.255`** `(172.16.0.0/12)`
   
   - **`192.168.0.0 - 192.168.255.255`** `(192.168.0.0/16)` 
   
   Также определить какие IP являются публичными, а какие - частными можно с помощью утилиты `ipcalc`.
   
   - **Частные IP-адреса**:
     
     - 10.0.0.45
     
     - 192.168.4.2
     
     - 172.20.250.4
     
     - 172.16.255.255
     
     - 10.10.10.10
   
   - **Публичные IP-адреса**:
     
     - 134.43.0.2
     
     - 172.0.2.1 (специальный, для документации)
     
     - 192.172.0.1
     
     - 172.68.0.2
     
     - 192.169.168.1

2. Используем утилиту `ipcalc` для определения возможных шлюзов в сети `10.10.0.0/18`
   
   ![host](images/1_3_host.png)
   
   *Вывод команды `ipcalc 10.10.0.0/18`*
   
   - На основе вывода можно определить, что возможные адреса шлюзов находятся в диапазоне от `10.10.0.1` до `10.10.63.254`
   
   - Теперь можем проверить каждый IP-адрес
     
     ![host](images/1_3_host4.png)
     
     *Диапазон шлюзов для `10.0.0.1`*
     
     ![host](images/1_3_host1.png)
     
     *Диапазон шлюзов для `10.10.0.2`*
     
     ![host](images/1_3_host1.png)
     
     *Диапазон шлюзов для `10.10.10.10`*
     
     ![host](images/1_3_host3.png)
     
     *Диапазон шлюзов для `10.10.100.1`*
     
     ![host](images/1_3_host2.png)
     
     *Диапазон шлюзов для `10.10.1.255`*
   
   - Таким образом, возможные IP-адреcа шлюза для сети `10.10.0.0/18`: **`10.10.0.2`, `10.10.10.10` и `10.10.1.255`**

## Part 2. Статическая маршрутизация между двумя машинами

- Просматриваем текущие сетевые интерфейсы с помощью команды `ip a`
  
  ![ipa](images/2_ipa1.png)
  
  *Сетевые интерфейсы `ws1`*
  
  ![ipa](images/2_ipa2.png)
  
  *Сетевые интерфейсы `ws2`*

- С помощью команды `sudo vim /etc/netplan/00-installer-config.yaml` заходим в конфигурационный файл и ставим соотвествующие адреса и маски машинам `ws1` и `ws2`
  
  ![ws1](images/2_ws1.png)
  
  *Статический адрес `ws1`*
  
  ![ws2](images/2_ws2.png)
  
  *Статический адрес `ws2`*

- Перезапускаем сервис сети для принятия изменений командой `sudo netplan apply` и проверяем установленные статические адреса командой `ip a`
  
  ![ipaws1](images/2_ws1_ipa.png)
  
  *IP-адрес `ws1`*
  
  ![ipaws2](images/2_ws2_ipa.png)
  
  *IP-адрес `ws2`*

#### 2.1 Добавление статического маршрута вручную

- Добавим статическую маршрутизацию с помощью команды `sudo ip route add` для каждой из машин, указывая соответсвующие другой машине IP-адреса
  
  ![route_ws1](images/2_1_route_ws1.png)
  
  *Статическая маршрутизация` ws1`*
  
  ![route_ws1](images/2_1_route_ws2.png)
  
  *Статическая маршрутизация `ws2`*

- Пропингуем соединение между машинами командой `ping -c 10 <address>` (перед этим необходимо переключить в VirtualBox настройки сети для каждой машины на `internal network`)
  
  ![ping1](images/2_1_ping_ws1.png)
  
  *Пинг `ws1`*
  
  ![ping2](images/2_1_ping_ws2.png)
  
  *Пинг `ws2`*

#### 2.2 Добавление статического маршрута с сохранением

- При перезапуске машины происходит сброс маршрутизации, для сохранения параметров маршрута редактируем конфигурационный файл `/etc/netplan/00-installer-config.yaml`
  
  ![route](images/2_2_route_save1.png)
  
  *Сохранения параметров маршрута `ws1`*
  
  ![route](images/2_2_route_save2.png)
  
  *Сохранения параметров маршрута `ws2`*

- Применяем изменения командой `sudo netplan apply` и пропингуем соединение
  
  ![ping1](images/2_2_ping_save1.png)
  
  *Пинг c `ws1`*
  
  ![ping2](images/2_2_ping_save2.png)
  
  *Пинг c `ws2`*

## Part 3. Утилита **iperf3**

#### 3.1 Скорость соединения

- 8 Mbps (мегабит в секуду) = 1 MB/s (мегабайт в секунду)

- 100 MB/s (мегабайт в секунду) = 800 000 Kbps (килобит в секунду)

- 1 Gbps (гигабит в секунду) = 1 000 Mbps (мегабит в секунду)

#### 3.2 Утилита iperf3

- Для установки утилиты `iperf3` необходимо подключение к сети Интернет. Для этого в настройках сети виртуальных машин включаем второй адаптер NAT, а затем редактируем конфигурационный файл `/etc/netplan/00-installer-config.yaml`, добавляя в него запись:
  
  ![nat](images/3_nat.png)

- Устанавливаем утилиту `iperf3` с помощью команды `sudo apt install iperf3`. Запускаем утилиту на машине ws2 для прослушаивания в качестве сервера командой `iperf3 -s`, а на машине ws1 используем команду клиентской стороны `iperf3 -c`
  
  ![iperf3](images/3_iperf3_2.png)
  
  *Используем `ws2` в качестве серверной стороны*
  
  ![iperf3](images/3_iperf3_1.png)
  
  *Используем `ws1` в качестве клиентской стороны*

## Part 4. Сетевой экран

#### 4.1 Утилита iptables

- Создаем файл `/etc/firewall.sh`, имитирующий файрвол, на `ws1` и `ws2`
  
  ![firewall1](images/4_firewall1.png)
  
  *Правила для `ws1`*
  
  ![firewall1](images/4_firewall2.png)
  
  *Правила для `ws2`*

- Запускаем файлы на обеих машинах командами `sudo chmod +x /etc/firewall.sh` и `/etc/firewall.sh` и выполняем команду `sudo iptables --line-numbers -L -v -n` для подтверждения добавления правил

- Такая стратегия ограничения доступа на выход позволяет первой машине пинговать, а второй нет, поскольку правила выполняются сверху вниз
  
  #### 4.2 Утилита nmap

- Пропингуем хосты внутри локальной сети машин `ws1` и `ws2`, как видно, правила не позволяют пинговать машине 2
  
  ![ping1](images/4_ping1.png)
  
  *Пинг машины `ws2`*
  
  ![ping1](images/4_ping2.png)
  
  *Пинг машины `ws1`*

- Для проверки, что хост работает, но при этом не пингуется используем утилиту `nmap`. Установим ее командой `sudo apt install nmap`. Вызываем команду `nmap` на `ws1`, наблюдается, что хост работает, но не пингуется
  
  ![ping1](images/4_nmap.png)
  
  *Работа утилиты `nmap` на `ws1`*

- Выполняем сохранение состояния виртуальных машин
  
  ![ping1](images/4_snap1.png)
  
  *Снимок ws1*
  
  ![ping1](images/4_snap1.png)
  
  *Снимок `ws2`*

## Part 5. Статическая маршрутизация сети

- Поднимаем 5 виртуальных машин (3 рабочие станции (`ws11`, `ws21`, `ws22`) и 2 роутера (`r1`, `r2`))
  
  ![ping1](images/5_ws.png)

#### 5.1 Настройка адресов машин

- Для каждой машины прописываем настройки сети в файле `/etc/netplan/00-installer-config.yaml` в соответствии с заданием и принимаем изменения командой `sudo netplan apply`
  
  ![ws11](images/5_ws11.png)
  
  *`ws11`*
  
  ![ws11](images/5_ws21.png)
  
  *`ws21`*
  
  ![ws11](images/5_ws22.png)
  
  *`ws22`*
  
  ![ws11](images/5_r1.png)
  
  *`r1`*
  
  ![ws11](images/5_r2.png)
  
  *`r2`*

- Проверяем, что адреса машин заданы верно командой `ip -4 a`
  
  ![ws11](images/5_ipa_ws11.png)
  
  *`ws11`*
  
  ![ws11](images/5_ipa_ws21.png)
  
  *`ws21`*
  
  ![ws11](images/5_ipa_ws22.png)
  
  *`ws22`*
  
  ![ws11](images/5_ipa_r1.png)
  
  *`r1`*
  
  ![ws11](images/5_ipa_r2.png)
  
  *`r2`*

- Пропингуем `ws22` с `ws21`, а также `r1` с `ws11`
  
  ![ws11](images/5_ping_ws22_ws21.png)
  
  *пинг `ws22` с `ws21`*
  
  ![ws11](images/5_ping_r1_ws11.png)
  
  *пинг `r1` с `ws11`*

#### 5.2 Включение переадресации IP-адресов

- Включаем переадресацию IP на роутерах командой `sudo sysctl -w net.ipv4.ip_forward=1`
  
  ![ws11](images/5_sys_r1.png)
  
  *`sysctl r1`*
  
  ![ws11](images/5_sys_r2.png)
  
  *`sysctl r1`*

- При таком подходе переадесация не будет работать после перезапуска системы, для включения переадресации на постоянной основе внесем изменения в файл `/etc/systcl.conf`
  
  ![ws11](images/5_sysctlconf1.png)
  
  *редактирование `sysctl.conf r1`*
  
  ![ws11](images/5_sysctlconf2.png)
  
  *редактирование `sysctl.conf r2`*

#### 5.3. Установка маршрута по-умолчанию

- Устанавливаем маршрут по-умолчанию для рабочих станций, добавляем ip роутера в файл `/etc/netplan/00-installer-config.yaml`
  
  ![ws11](images/5_default_ws11.png)
  
  *`ws11`*
  
  ![ws11](images/5_default_ws21.png)
  
  *`ws21`*
  
  ![ws11](images/5_default_ws22.png)
  
  *`ws22`*

- Проверяем добавление шлюза в таблицу маршрутизации командой `ip r`
  
  ![ws11](images/5_ipr_ws11.png)
  
  *`ip r ws11`*
  
  ![ws11](images/5_ipr_ws21.png)
  
  *`ip r ws21`*
  
  ![ws11](images/5_ipr_ws22.png)
  
  *`ip r ws22`*

- Пропингуем с `ws11` роутер `r2`, однако наблюдаем, что роутер не возвращает ответ, хотя и принимает запрос
  
  ![ws11](images/5_ping_ws11_r2.png)

- Проверяем это, запуская команду `sudo tcpdump -tn -i enp0s8` на `r2` и снова пингуем с `ws11` командой `ping -c 5 <address>`
  
  ![ws11](images/5_tcpdump.png)
  
  *Результат при вызове `tcpdump` на `r2` и пинге c `ws11`*

#### 5.4. Добавление статических маршрутов

- Для добавления статических маршрутов отредактируем файл `/etc/netplan/00-installer-config.yaml` на обоих роутерах
  
  ![ws11](images/5_route_r1.png)
  
  *`r1`*
  
  ![ws11](images/5_route_r2.png)
  
  *`r2`*

- Вызовем таблицу маршрутизации для `r1` и `r2` командой `ip r`
  
  ![ws11](images/5_ipr_r1.png)
  
  *`r1`*
  
  ![ws11](images/5_ipr_r2.png)
  
  *`r2`*

- Вызываем команды `ip r list 10.10.0.0/18` и `ip r list 0.0.0.0/0`
  
  ![ws11](images/5_ipr_list.png)

- Для адреса `10.10.0.0/18` был выбран маршрут, отличный от `0.0.0.0/0` (маршрут по-умолчанию), так как машина `ws11` соединена с сетью `10.10.0.0/18` по своему IP-адресу `10.10.0.2`, для других адресов используется маршрут по умолчанию (`10.10.0.1`)

#### 5.5 Построение списка маршрутизаторов

- Запустим на роутере `r1` команду `sudo tcpdump -tnv -i enp0s8` и пропингуем соединение от `ws11` до `ws21` командой `ping -c 10 10.20.0.10`
  
  ![ws11](images/5_5_dump.png)

- Построим список маршрутизации от `ws11` до `ws21` с помощью команды `traceroute 10.20.0.10`
  
  ![ws11](images/5_5_traceroute.png)

- Инструмент traceroute отправляет пакеты на IP-адрес назначения и со сроком жизни (TTL), установленным на 1, соответственно, первый маршрутизатор, на который придут пакеты, отправит обратно ошибку ("время превышено"). При возврате ошибки инструмент traceroute записывает идентификатор первого маршрутизатора и время приема-передачи, увеличивает TTL и отправляет новые пакеты, повторяя этот процесс до тех пор, пока последний пакет не достигнет IP-адреса назначения или два набора пакетов не будут отклонены. Таким образом инструмент позволяет определить путь, по которому проходят ваши пакеты, и время в оба конца до каждого перехода, чтобы вы могли устранить потерю пакетов и задержку.

#### 5.6 Использование протокола **ICMP** при маршрутизации

- Запускаем на `r1` команду `tcpdump -n -i enp0s8 icmp` для перехвата сетевого траффика и пингуем несуществующий IP с `ws11`
  
  ![ws11](images/5_6_tcpdump.png)
  
  ![ws11](images/5_6_ping.png)

- Выполняем сохранение состояния виртуальных машин

## Part 6. Динамическая настройка IP с помощью **DHCP**

- Для начала работы с DHCP сервером устанавливаем его командой `sudo apt install isc-dhcp-server`

- Далее настраиваем для `r2` в файле `/etc/dhcp/dhcpd.conf` конфигурацию службы DHCP: указываем адрес маршрутизатора по-умолчанию, DNS-сервер и адрес внутренней сети
  
  ![ws11](images/6_dhcpdconf.png)
  
  *`r2`*

- Прописываем nameserver `8.8.8.8` в файле `/etc/resolv.conf` и перезагружаем службу DHCP командой `systemctl restart isc-dhcp-server`
  
  ![ws11](images/6_resolv.png)
  
  *`r2`*
  
  ![ws11](images/6_restart.png)

- Для того, чтобы `ws21` получала динамические адреса следует отредактировать файл `/etc/netplan/00-installer-config.yaml` и поставить `dhcp true`
  
  ![ws11](images/6_dhcp_true.png)

- Вызываем команду `ip a` на машине `ws21` и наблюдаем динамическое присвоение адреса
  
  ![ws11](images/6_ipa_ws21.png)

- Пингуем `ws22` с `ws21`
  
  ![ws11](images/6_ping_ws22_ws21.png)

- Прописываем на машину `ws11` MAC адрес в `etc/netplan/00-installer-config.yaml`
  
  ![ws11](images/6_mac_ws11.png)

- Ставим на `r1` как и на `r2` `dhcp-server` командой `sudo apt-get install isc-dhcp-server`, редактируем файл `/etc/dhcp/dhcpd.conf` с жесткой привязкой к MAC следующим образом
  
  ![ws11](images/6_dhcpconf.png)

- Редактируем файл `/etc/resolv.conf`, внося данные о DNS-сервере
  
  ![ws11](images/6_resolv_r1.png)

- Перезапускаем DHCP-службу командой `systemctl restart isc-dhcp-server`
  
  ![ws11](images/6_restart1.png)

- Проверяем назначение IP-адреса, привязанного к MAC, у машины `ws11` командой `ip a`
  
  ![ws11](images/6_ipa_ws11.png)

- Пропингуем `ws22` с `ws11`
  
  ![ws11](images/6_ping_ws22_ws11.png)

- Проверяем текущий `ip` на `ws21` командой `ip a`
  
  ![ws11](images/6_ipa_ws21_1.png)

- Освобождаем текущий IP командой `sudo dhclient -r` и получаем новый командой `sudo dhclient` и проверяем назначение нового адреса командой `ip a`
  
  ![ws11](images/6_dhclient.png)

## Part 7. **NAT**

- Устанавливаем `Apache2` командой `sudo apt install apache2` на машинах `r1` и `ws22`, меняем порт `80` на `0.0.0.0:80` в файле `/etc/apache2/ports.conf` на обеих машинах
  
  ![ws11](images/7_port_ws22.png)
  
  *`ws22`*
  
  ![ws11](images/7_port_r1.png)
  
  *`r1`*

- Запускаем сервер Apache2 командой `service apache2 start` на обеих машинах
  
  ![ws11](images/7_apache_start_ws22.png)
  
  *`ws22`*
  
  ![ws11](images/7_apache_start_r1.png)
  
  *`r1`*

- На машине `r2` создаем `firewall` с помощью команды `sudo touch /etc/firewall.sh` и добавляем следующие правила:
  
  - Удаление правил в таблице `filter` — `iptables -F`
  
  - Удаление правил в таблице «NAT» — `iptables -F -t nat`
  
  - Отбрасывать все маршрутизируемые пакеты — `iptables --policy FORWARD DROP`
    
    ![ws11](images/7_firewall.png)

- Запускаем `firewall` командами `chmod +x /etc/firewall.sh` и `/etc/firewall.sh` и проверяем добавление правил командой `sudo iptables --line-numbers -L -v -n`
  
  ![ws11](images/7_firewall_1.png)

- Пропингуем `ws22` с `r1` и видим, что она не пингуется
  
  ![ws11](images/7_ping_r1_ws22.png)

- Добавляем в `firewall` правило, разрешающее маршрутизацию пакетов по протоколу `ICMP`
  
  ![ws11](images/7_firewall_add.png)

- Снова пропингуем `ws22` с `r1`, в этот раз `ws22` пингуется
  
  ![ws11](images/7_ping_r1_ws22_1.png)

- Добавляем в `/etc/firewall.sh` правила `SNAT` и `DNAT` на машине `r2`
  
  ![ws11](images/7_firewall_snat_dnat.png)

- Отключаем сетевой интерфейс NAT в Virtual Box и запускаем firewall `chmod +x /etc/firewall.sh` и `/etc/firewall.sh`, запускаем команды `telnet 10.100.0.11 80` на машине `ws22` и `telnet 10.100.0.12 8080` на `r1`. В случае `r1` подключаемся к `ws22` через сетевой интерфейс `r2`
  
  ![ws11](images/7_telnet_ws22.png)
  
  *`ws22`*
  
  ![ws11](images/7_telnet_r1.png)
  
  *`r1`*

## Part 8. Дополнительно. Знакомство с **SSH Tunnels**

- Запускаем firewall из части 7 командами `chmod +x /etc/firewall.sh` и `/etc/firewall.sh` и меняем веб-сервер Apache2 на `ws22`, только на `localhost`, отредактировав файл `/etc/apache2/ports.conf`
  
  ![ws11](images/8_localhost.png)
  
  *`ws22`*  

- Запускаем `ssh` на `ws22` командой `sudo systemctl start ssh`, затем открываем `ssh` соединение на `ws21` c сервером на `ws22` (Local TCP forwarding)
  ![ws11](images/8_ssh_ws21_ws22.png)
  
  *`ws21`*  
  
  ![ws11](images/8_ssh_connect_ws22.png)
  
  *`ws21`*  

- Проверяем запущенный процесс на `ws22`
  
  ![ws11](images/8_grepsshd.png)
  
  *`ws22`*  

- Чтобы получить доступ к веб-серверу на `ws22` с `ws11` используем Remote TCP forwarding командой `ssh -R 8080:localhost:80 10.20.0.20`
  
  ![ws11](images/8_ssh_ws11_ws22.png)
  
  *`ws11`*  
